# CloudKit Production Schema Setup Guide

## Overview

This guide walks you through deploying the CloudKit schema to production for the Oralable app. This **MUST** be completed before App Store release, as the app uses CloudKit's public database for patient-dentist data sharing.

## Prerequisites

- Apple Developer account with Admin or App Manager role
- Access to CloudKit Console
- Both apps (Patient and Dentist) must be created in App Store Connect

---

## Step 1: Access CloudKit Console

1. Navigate to [CloudKit Console](https://icloud.developer.apple.com/dashboard)
2. Sign in with your Apple Developer credentials
3. Select the container: **iCloud.com.jacdental.oralable.shared**
   - If the container doesn't exist, create it:
     - Click "+" to create new container
     - Enter identifier: `iCloud.com.jacdental.oralable.shared`
     - Confirm creation

---

## Step 2: Create Record Types

You need to create 3 record types in the **Public Database**. For each record type below:

### 2.1 ShareInvitation Record Type

**Purpose**: Stores share codes generated by patients for dentist access

1. Click **Schema** in left sidebar
2. Select **Public Database** (NOT Private Database)
3. Click **Record Types** tab
4. Click "+" to add new record type
5. Name: `ShareInvitation`
6. Add the following fields:

| Field Name | Field Type | Indexed | Sortable |
|------------|-----------|---------|----------|
| `shareCode` | String | ✓ Yes | No |
| `patientID` | String | ✓ Yes | No |
| `expiryDate` | Date/Time | ✓ Yes | ✓ Yes |
| `used` | Int64 | ✓ Yes | No |

7. Click **Save**

**Indexes to Create**:
- Index on `shareCode` (for quick lookups when dentist enters code)
- Index on `patientID` (for finding invitations by patient)
- Index on `expiryDate` (for cleanup of expired codes)

### 2.2 SharedPatientData Record Type

**Purpose**: Stores the relationship between patient and dentist after share code is redeemed

1. Click "+" to add new record type
2. Name: `SharedPatientData`
3. Add the following fields:

| Field Name | Field Type | Indexed | Sortable |
|------------|-----------|---------|----------|
| `patientID` | String | ✓ Yes | No |
| `dentistID` | String | ✓ Yes | No |
| `shareCode` | String | ✓ Yes | No |
| `accessGrantedDate` | Date/Time | No | ✓ Yes |
| `lastDataUpdate` | Date/Time | No | ✓ Yes |
| `isRevoked` | Int64 | ✓ Yes | No |

4. Click **Save**

**Indexes to Create**:
- Compound index on `dentistID` + `isRevoked` (for dentist to query active patients)
- Index on `patientID` (for patient to manage their shares)
- Index on `shareCode` (for linking to ShareInvitation)

### 2.3 HealthDataRecord Record Type

**Purpose**: Stores actual health data uploaded by patients (recordings, bruxism events, etc.)

1. Click "+" to add new record type
2. Name: `HealthDataRecord`
3. Add the following fields:

| Field Name | Field Type | Indexed | Sortable |
|------------|-----------|---------|----------|
| `patientID` | String | ✓ Yes | No |
| `recordingDate` | Date/Time | ✓ Yes | ✓ Yes |
| `sessionDuration` | Double | No | ✓ Yes |
| `bruxismEvents` | Int64 | No | ✓ Yes |
| `averageIntensity` | Double | No | ✓ Yes |
| `peakIntensity` | Double | No | ✓ Yes |
| `heartRateData` | Bytes | No | No |
| `oxygenSaturation` | Bytes | No | No |

4. Click **Save**

**Indexes to Create**:
- Compound index on `patientID` + `recordingDate` (for querying patient's data in date range)
- Index on `recordingDate` (for sorting by date)

---

## Step 3: Configure Security & Permissions

### 3.1 Public Database Permissions

1. In CloudKit Console, select **Security Roles**
2. For each record type (ShareInvitation, SharedPatientData, HealthDataRecord):
   - **World** (unauthenticated):
     - Create: ❌ None
     - Read: ❌ None
     - Write: ❌ None
   - **Authenticated** (signed-in users):
     - Create: ✓ Yes
     - Read: ✓ Yes (with query filters)
     - Write: ✓ Yes (own records only)
   - **Creator** (record owner):
     - Create: ✓ Yes
     - Read: ✓ Yes
     - Write: ✓ Yes
     - Delete: ✓ Yes (for ShareInvitation and HealthDataRecord)

### 3.2 Queryable Fields

Ensure these fields are queryable for security:
- ShareInvitation: `shareCode`, `patientID`, `expiryDate`
- SharedPatientData: `dentistID`, `patientID`, `isRevoked`
- HealthDataRecord: `patientID`, `recordingDate`

---

## Step 4: Deploy to Production

1. Review all record types in **Development** environment first
2. Test with the apps in DEBUG mode (uses private database currently)
3. When ready to deploy:
   - Click **Deploy Schema Changes** button
   - Select **Production** environment
   - Review the schema diff
   - Click **Deploy**
4. Wait for deployment to complete (usually 5-15 minutes)

**⚠️ WARNING**: Once deployed to production, schema changes are permanent and cannot be rolled back easily. Test thoroughly in development first!

---

## Step 5: Verify Deployment

1. In CloudKit Console, switch to **Production** environment (top dropdown)
2. Verify all 3 record types exist:
   - ShareInvitation ✓
   - SharedPatientData ✓
   - HealthDataRecord ✓
3. Verify all indexes are created
4. Verify security roles are configured correctly

---

## Step 6: Update App Configuration

After production schema is deployed, the apps are already configured to use the production public database when built in RELEASE mode:

**Patient App** (`SharedDataManager.swift:64-68`):
```swift
#if DEBUG
self.publicDatabase = container.privateCloudDatabase // Development
#else
self.publicDatabase = container.publicCloudDatabase // Production
#endif
```

**Dentist App** (`DentistDataManager.swift:94-98`):
```swift
#if DEBUG
self.publicDatabase = container.privateCloudDatabase // Development
#else
self.publicDatabase = container.publicCloudDatabase // Production
#endif
```

No code changes required - just build in RELEASE mode for App Store submission.

---

## Step 7: Testing

Before App Store submission, test the production database:

1. Build both apps in RELEASE configuration
2. Install on physical devices (not simulator)
3. Test the complete flow:
   - Patient generates share code
   - Dentist enters share code
   - Patient uploads health data
   - Dentist views patient data
4. Monitor CloudKit Console for any errors
5. Check CloudKit Usage metrics

---

## Estimated Time

- Schema creation: 30 minutes
- Testing in development: 1 hour
- Production deployment: 15 minutes
- Verification and testing: 1-2 hours
- **Total: 3-4 hours**

---

## Troubleshooting

### Problem: "Container not found"
**Solution**: Ensure the container identifier matches exactly: `iCloud.com.jacdental.oralable.shared`

### Problem: "Permission denied" errors in app
**Solution**: Check Security Roles - ensure authenticated users can create/read records

### Problem: Share codes not working
**Solution**: Verify `shareCode` field is indexed and queryable

### Problem: Dentist can't see patient data
**Solution**:
1. Verify SharedPatientData record exists linking the two users
2. Check `isRevoked` is set to 0
3. Ensure HealthDataRecord has correct `patientID`

---

## Maintenance

### Cleanup Expired Share Codes

Periodically run a CloudKit query to delete expired ShareInvitation records:
- Query: `expiryDate < NOW() AND used = 0`
- Delete matching records
- This can be automated with a server-side script or CloudKit trigger

### Monitor Usage

Keep an eye on CloudKit usage metrics:
- **Requests per second**: Should stay well below limits
- **Storage**: Each HealthDataRecord is small (~5-50KB)
- **Transfer**: Depends on how often dentists query patient data

**CloudKit Limits** (Free tier):
- 40 requests/second
- 10 GB storage
- 200 GB transfer/month

If you exceed these, you'll need to enable CloudKit paid tier.

---

## Security Considerations

1. **Patient data is NOT encrypted at rest** in CloudKit by default
   - Consider implementing client-side encryption for sensitive health data
   - Store encryption keys in Keychain

2. **Share codes are 6 digits** - ensure proper rate limiting
   - Current implementation: 48-hour expiry helps mitigate brute force

3. **Dentist access is permanent** once granted
   - Patients can revoke by setting `isRevoked = 1`
   - Consider implementing automatic expiry after X months

4. **HIPAA Compliance**: CloudKit may not be HIPAA-compliant
   - For full HIPAA compliance, consider using CloudKit only for access control
   - Store actual PHI (Protected Health Information) on a HIPAA-compliant backend

---

## Next Steps

After completing CloudKit setup, proceed to:
- [App Store Connect In-App Purchase Configuration](APP_STORE_CONNECT_IAP_SETUP.md)
- Submit apps for TestFlight Beta Review
- Conduct end-to-end testing with real dentist and patient accounts
